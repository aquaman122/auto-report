const { createWikiClient, wikiConfig } = require('../config/wiki');
const logger = require('../utils/logger');
const { formatToMarkdown } = require('../utils/wikiFormatter');

class WikiService {
  constructor() {
    this.client = createWikiClient();
  }

  // Wiki í˜ì´ì§€ ìƒì„±
  async createPage(pageData) {
    try {
      const { title, content, space, tags, metadata } = pageData;
      
      // ë§ˆí¬ë‹¤ìš´ í¬ë§·íŒ…
      const formattedContent = formatToMarkdown(content);
      
      // í˜ì´ì§€ ë°ì´í„° êµ¬ì„±
      const payload = {
        title: title,
        content: formattedContent,
        space: space || wikiConfig.spaceKey,
        type: 'page',
        status: 'published',
        tags: Array.isArray(tags) ? tags : [],
        metadata: metadata || {}
      };

      logger.info(`ğŸ“ Wiki í˜ì´ì§€ ìƒì„± ì‹œì‘: ${title}`);
      
      const response = await this.client.post('/api/pages', payload);
      
      logger.info(`âœ… Wiki í˜ì´ì§€ ìƒì„± ì™„ë£Œ: ${response.data.id || response.data.key}`);
      
      return {
        success: true,
        pageId: response.data.id || response.data.key,
        url: response.data.url || response.data._links?.webui,
        title: response.data.title,
        data: response.data
      };
      
    } catch (error) {
      logger.error('âŒ Wiki í˜ì´ì§€ ìƒì„± ì‹¤íŒ¨:', error.message);
      
      return {
        success: false,
        error: error.message,
        details: error.response?.data || error
      };
    }
  }

  // Wiki í˜ì´ì§€ ì—…ë°ì´íŠ¸
  async updatePage(pageId, pageData) {
    try {
      const { title, content, tags } = pageData;
      
      const formattedContent = formatToMarkdown(content);
      
      const payload = {
        title: title,
        content: formattedContent,
        tags: Array.isArray(tags) ? tags : []
      };

      logger.info(`ğŸ“ Wiki í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘: ${pageId}`);
      
      const response = await this.client.put(`/api/pages/${pageId}`, payload);
      
      logger.info(`âœ… Wiki í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${pageId}`);
      
      return {
        success: true,
        pageId: pageId,
        url: response.data.url || response.data._links?.webui,
        data: response.data
      };
      
    } catch (error) {
      logger.error('âŒ Wiki í˜ì´ì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
      
      return {
        success: false,
        error: error.message,
        details: error.response?.data || error
      };
    }
  }

  // Wiki í˜ì´ì§€ ê²€ìƒ‰
  async searchPages(query, space = null) {
    try {
      const params = {
        q: query,
        space: space || wikiConfig.spaceKey,
        limit: 10
      };

      const response = await this.client.get('/api/search', { params });
      
      return {
        success: true,
        results: response.data.results || response.data,
        total: response.data.total || response.data.length
      };
      
    } catch (error) {
      logger.error('âŒ Wiki í˜ì´ì§€ ê²€ìƒ‰ ì‹¤íŒ¨:', error.message);
      
      return {
        success: false,
        error: error.message
      };
    }
  }

  // íšŒì˜ë¡ì„ Wiki í˜ì´ì§€ë¡œ ë³€í™˜
  async createMeetingPage(meetingData) {
    try {
      const { 
        title, 
        date, 
        summary, 
        participants, 
        agendas, 
        actionItems, 
        metadata 
      } = meetingData;

      // Wiki í˜ì´ì§€ ì œëª© ìƒì„±
      const pageTitle = `íšŒì˜ë¡_${date}_${title.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_')}`;
      
      // ë§ˆí¬ë‹¤ìš´ ì»¨í…ì¸  ìƒì„±
      const content = this.generateMeetingMarkdown(meetingData);
      
      // íƒœê·¸ ìƒì„±
      const tags = [
        'íšŒì˜ë¡',
        'ìë™ìƒì„±',
        date,
        `ì°¸ì„ì${Array.isArray(participants) ? participants.length : 0}ëª…`,
        `ì•¡ì…˜ì•„ì´í…œ${Array.isArray(actionItems) ? actionItems.length : 0}ê°œ`
      ];

      // Wiki í˜ì´ì§€ ìƒì„±
      const result = await this.createPage({
        title: pageTitle,
        content: content,
        space: wikiConfig.spaceKey,
        tags: tags,
        metadata: {
          meetingId: metadata?.meetingId,
          processingTime: metadata?.processingTime,
          autoGenerated: true,
          generatedAt: new Date().toISOString()
        }
      });

      return result;
      
    } catch (error) {
      logger.error('âŒ íšŒì˜ë¡ Wiki í˜ì´ì§€ ìƒì„± ì‹¤íŒ¨:', error.message);
      
      return {
        success: false,
        error: error.message
      };
    }
  }

  // íšŒì˜ë¡ ë§ˆí¬ë‹¤ìš´ ìƒì„±
  generateMeetingMarkdown(meetingData) {
    const {
      title,
      date,
      summary,
      participants,
      agendas,
      actionItems,
      documents,
      metadata
    } = meetingData;

    // ì°¸ì„ì í¬ë§·íŒ…
    const participantsText = Array.isArray(participants) && participants.length > 0 ?
      participants.map(p => {
        if (typeof p === 'object') {
          return `- **${p.name || p}** ${p.department ? `(${p.department})` : ''} ${p.role_in_meeting ? `- ${p.role_in_meeting}` : ''}`;
        }
        return `- ${p}`;
      }).join('\n') :
      'ì°¸ì„ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';

    // ì•ˆê±´ í¬ë§·íŒ…
    const agendasText = Array.isArray(agendas) && agendas.length > 0 ?
      agendas.map((agenda, index) => `
### ${index + 1}. ${agenda.agenda_title || `ì•ˆê±´ ${index + 1}`}

**ë…¼ì˜ ë‚´ìš©:**
${agenda.discussion_content || 'ë…¼ì˜ ë‚´ìš© ì—†ìŒ'}

**í•µì‹¬ í¬ì¸íŠ¸:**
${Array.isArray(agenda.key_points) ? agenda.key_points.map(point => `- ${point}`).join('\n') : 'ì—†ìŒ'}

**ê²°ì • ì‚¬í•­:**
${agenda.decisions ? (typeof agenda.decisions === 'object' ? JSON.stringify(agenda.decisions, null, 2) : agenda.decisions) : 'ì—†ìŒ'}

**ë‹¤ìŒ ë‹¨ê³„:**
${Array.isArray(agenda.next_steps) ? agenda.next_steps.map(step => `- ${step}`).join('\n') : 'ì—†ìŒ'}
`).join('\n') :
      'ì•ˆê±´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';

    // ì•¡ì…˜ì•„ì´í…œ í¬ë§·íŒ…
    const actionItemsText = Array.isArray(actionItems) && actionItems.length > 0 ?
      actionItems.map((item, index) => {
        if (typeof item === 'object') {
          return `${index + 1}. **${item.task_description || item.task || item}**
   - ë‹´ë‹¹ì: ${item.assignee || 'ë¯¸ì •'}
   - ë§ˆê°ì¼: ${item.deadline || 'ë¯¸ì •'}
   - ìš°ì„ ìˆœìœ„: ${item.priority || 'ë³´í†µ'}
   - ìƒíƒœ: ${item.status || 'ì§„í–‰ ì¤‘'}`;
        }
        return `${index + 1}. ${item}`;
      }).join('\n\n') :
      'ì•¡ì…˜ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.';

    // ë§ˆí¬ë‹¤ìš´ ìƒì„±
    return `
# ${title}

> ğŸ“… **íšŒì˜ ë‚ ì§œ**: ${date}  
> â±ï¸ **ì²˜ë¦¬ ì‹œê°„**: ${metadata?.processingTime || 'N/A'}ì´ˆ  
> ğŸ†” **íšŒì˜ ID**: ${metadata?.meetingId}  
> ğŸ¤– **ìë™ ìƒì„±**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

---

## ğŸ‘¥ ì°¸ì„ì
${participantsText}

---

## ğŸ“ íšŒì˜ ìš”ì•½
${summary || 'ìš”ì•½ ì—†ìŒ'}

---

## ğŸ“‹ ì£¼ìš” ì•ˆê±´
${agendasText}

---

## âœ… ì•¡ì…˜ ì•„ì´í…œ (${Array.isArray(actionItems) ? actionItems.length : 0}ê°œ)
${actionItemsText}

---

## ğŸ“ ê´€ë ¨ ë¬¸ì„œ
${Object.keys(documents || {}).length > 0 ? 
  Object.keys(documents).map(format => 
    `- [${format.toUpperCase()} íŒŒì¼ ë‹¤ìš´ë¡œë“œ](${documents[format].url || '#'})`
  ).join('\n') : 
  'ê´€ë ¨ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.'
}

---

## ğŸ“Š íšŒì˜ í†µê³„
- **ì´ ì°¸ì„ì**: ${Array.isArray(participants) ? participants.length : 0}ëª…
- **ë…¼ì˜ëœ ì•ˆê±´**: ${Array.isArray(agendas) ? agendas.length : 0}ê°œ
- **ì•¡ì…˜ ì•„ì´í…œ**: ${Array.isArray(actionItems) ? actionItems.length : 0}ê°œ
- **ì²˜ë¦¬ ì‹œê°„**: ${metadata?.processingTime || 'N/A'}ì´ˆ

---

*ì´ ë¬¸ì„œëŠ” ìŒì„± íšŒì˜ë¡ ìë™í™” ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*  
*ìƒì„± ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}*
`;
  }
}

module.exports = WikiService;